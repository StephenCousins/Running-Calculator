<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Running Calculator Suite - 7 Professional Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FF9900;
            text-shadow: none;
        }

        .header p {
            font-size: 1.2em;
            color: #666;
        }

        /* Compact header bar - always visible */
        .calculator-header-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #FF9900 0%, #FF8800 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .active-calculator-name {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change-calculator-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .change-calculator-btn:hover {
            background: white;
            color: #FF9900;
            transform: scale(1.05);
        }

        /* Slide-out drawer */
        .calculator-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .calculator-drawer.active {
            display: flex;
            opacity: 1;
        }

        .drawer-content {
            background: white;
            width: 90%;
            max-width: 900px;
            margin: auto;
            border-radius: 20px;
            padding: 30px;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .calculator-drawer.active .drawer-content {
            transform: scale(1);
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .drawer-header h2 {
            color: #FF9900;
            margin: 0;
        }

        .close-drawer-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            margin: 0;
        }

        .close-drawer-btn:hover {
            background: #FFF8F0;
            color: #FF9900;
        }

        .calculator-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .calculator-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }

        .calculator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255,153,0,0.2);
            border-color: #FF9900;
        }

        .calculator-card.active {
            border-color: #FF9900;
            background: linear-gradient(135deg, #FFF8F0 0%, #FFE8CC 100%);
        }

        .calculator-card h3 {
            color: #FF9900;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .calculator-card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .calculator-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .calculator-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            scroll-margin-top: 20px;
        }

        .calculator-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #FF9900;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
        }

        .time-inputs input {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FF9900 0%, #FF8800 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 20px;
        }

        button:hover {
            transform: scale(1.02);
        }

        button:active {
            transform: scale(0.98);
        }

        .result {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #FFF8F0 0%, #FFE8CC 100%);
            border-radius: 10px;
            border-left: 5px solid #FF9900;
        }

        .result h3 {
            color: #FF9900;
            margin-bottom: 15px;
        }

        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .result-item strong {
            color: #FF9900;
        }

        .info-box {
            background: #FFF8F0;
            border-left: 4px solid #FF9900;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            color: #555;
            line-height: 1.6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        table th {
            background: #FF9900;
            color: white;
            font-weight: 600;
        }

        table tr:hover {
            background: #f5f7fa;
        }

        .toggle-section {
            margin-top: 15px;
            padding: 12px;
            background: #FF9900;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-section:hover {
            background: #FF8800;
            transform: translateY(-2px);
        }

        .collapsible-content {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .collapsible-content.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            background: #f5f7fa;
            padding: 5px;
            border-radius: 10px;
        }

        .mode-button {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }

        .mode-button:hover {
            border-color: #FF9900;
        }

        .mode-button.active {
            background: linear-gradient(135deg, #FF9900 0%, #FF8800 100%);
            color: white;
            border-color: #FF9900;
        }

        .race-input-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
        }

        .race-input-group h4 {
            color: #FF9900;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .calibration-box {
            background: linear-gradient(135deg, #FFF8F0 0%, #FFE8CC 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #FF9900;
        }

        .calibration-box h3 {
            color: #FF8800;
            margin-bottom: 10px;
        }

        .calibration-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,153,0,0.2);
        }

        .calibration-stat:last-child {
            border-bottom: none;
        }

        .calibration-stat strong {
            color: #FF9900;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prediction-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .prediction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #FF9900 0%, #FF8800 100%);
        }

        .prediction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255,153,0,0.15);
            border-color: #FF9900;
        }

        .prediction-card.ultra {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border-color: #ff6b6b;
        }

        .prediction-card.ultra::before {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .prediction-distance {
            font-size: 1.3em;
            font-weight: bold;
            color: #FF9900;
            margin-bottom: 10px;
        }

        .prediction-card.ultra .prediction-distance {
            color: #ff6b6b;
        }

        .prediction-time {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
        }

        .prediction-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.6;
        }

        .prediction-details div {
            margin: 5px 0;
        }

        .confidence-bar {
            margin-top: 15px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .confidence-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .warning-box p {
            color: #856404;
            margin: 5px 0;
            line-height: 1.6;
        }

        .tip-box {
            background: #d1f2eb;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .tip-box h4 {
            color: #117a65;
            margin-bottom: 10px;
        }

        .tip-box ul {
            margin-left: 20px;
            color: #0e6655;
            line-height: 1.8;
        }

        .pacing-guide {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .pacing-guide h3 {
            color: #FF9900;
            margin-bottom: 15px;
        }

        .pace-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .pace-row:last-child {
            border-bottom: none;
        }

        .pace-label {
            font-weight: 600;
            color: #555;
        }

        .pace-value {
            color: #FF9900;
            font-weight: bold;
        }

        small {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }

        ul {
            margin-left: 20px;
        }

        ul li {
            margin: 8px 0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.9em;
            }

            .calculator-header-bar {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .active-calculator-name {
                font-size: 1em;
                justify-content: center;
            }

            .change-calculator-btn {
                width: 100%;
                justify-content: center;
            }

            .drawer-content {
                width: 95%;
                padding: 20px;
                max-height: 90vh;
            }

            .calculator-selector {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .predictions-grid {
                grid-template-columns: 1fr;
            }

            .mode-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>🏃 Complete Running Calculator Suite</h1>
            <p>7 Professional Tools for Runners - VO₂ Max, Pace, Ultra Race Prediction, Age Grading, Elevation, Training Zones & Nutrition</p>
        </div>

        <!-- Compact header bar showing active calculator -->
        <div class="calculator-header-bar">
            <div class="active-calculator-name">
                <span id="active-calc-icon">💨</span>
                <span id="active-calc-name">VO₂ Max Calculator</span>
            </div>
            <button class="change-calculator-btn" onclick="openDrawer()">
                <span>Change Tool</span>
                <span>⚡</span>
            </button>
        </div>

        <!-- Slide-out drawer with all calculators -->
        <div class="calculator-drawer" id="calculator-drawer" onclick="closeDrawerOnBackground(event)">
            <div class="drawer-content">
                <div class="drawer-header">
                    <h2>Choose Your Calculator</h2>
                    <button class="close-drawer-btn" onclick="closeDrawer()">×</button>
                </div>
                <div class="calculator-selector">
                    <div class="calculator-card active" data-calc="vo2max" data-icon="💨" data-name="VO₂ Max Calculator" onclick="selectCalculator('vo2max', '💨', 'VO₂ Max Calculator')">
                        <div class="calculator-icon">💨</div>
                        <h3>VO₂ Max Calculator</h3>
                        <p>Estimate your aerobic capacity using VDOT, FMR, or Cooper tests</p>
                    </div>
                    <div class="calculator-card" data-calc="pace" data-icon="⏱️" data-name="Pace Calculator" onclick="selectCalculator('pace', '⏱️', 'Pace Calculator')">
                        <div class="calculator-icon">⏱️</div>
                        <h3>Pace Calculator</h3>
                        <p>Calculate your running pace, speed, and splits for any distance</p>
                    </div>
                    <div class="calculator-card" data-calc="race" data-icon="🎯" data-name="Race Time Predictor" onclick="selectCalculator('race', '🎯', 'Race Time Predictor')">
                        <div class="calculator-icon">🎯</div>
                        <h3>Race Time Predictor</h3>
                        <p>Ultra-accurate predictions from 5K to 100 miles with personalized calibration</p>
                    </div>
                    <div class="calculator-card" data-calc="agegrading" data-icon="📊" data-name="Age Grading Calculator" onclick="selectCalculator('agegrading', '📊', 'Age Grading Calculator')">
                        <div class="calculator-icon">📊</div>
                        <h3>Age Grading Calculator</h3>
                        <p>Calculate age-graded performance based on WMA standards</p>
                    </div>
                    <div class="calculator-card" data-calc="elevation" data-icon="⛰️" data-name="Elevation Adjustment" onclick="selectCalculator('elevation', '⛰️', 'Elevation Adjustment')">
                        <div class="calculator-icon">⛰️</div>
                        <h3>Elevation Adjustment</h3>
                        <p>Adjust race predictions for elevation gain and mountainous terrain</p>
                    </div>
                    <div class="calculator-card" data-calc="zones" data-icon="🎯" data-name="Training Zones" onclick="selectCalculator('zones', '🎯', 'Training Zones')">
                        <div class="calculator-icon">🎯</div>
                        <h3>Training Zones</h3>
                        <p>Calculate heart rate and pace zones for optimal training</p>
                    </div>
                    <div class="calculator-card" data-calc="nutrition" data-icon="🍌" data-name="Nutrition Calculator" onclick="selectCalculator('nutrition', '🍌', 'Nutrition Calculator')">
                        <div class="calculator-icon">🍌</div>
                        <h3>Nutrition Calculator</h3>
                        <p>Calculate calories, carbs, and hydration needs for your runs</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VO2 Max Calculator -->
        <div id="vo2max-calculator" class="calculator-content active">
            <h2>VO₂ Max Calculator</h2>
            <div class="info-box">
                <p><strong>What is VO₂ Max?</strong> VO₂ Max is the maximum amount of oxygen your body can utilize during intense exercise. It's measured in milliliters of oxygen per kilogram of body weight per minute (ml/kg/min).</p>
            </div>

            <div class="form-group">
                <label for="vo2-test-type">Select Test Type:</label>
                <select id="vo2-test-type" onchange="showVO2TestForm()">
                    <option value="">-- Select a Test --</option>
                    <option value="vdot">VDOT Formula (Running Performance)</option>
                    <option value="custom">FMR VO₂ Max (Comprehensive)</option>
                    <option value="cooper">Cooper Test (12-Minute Run)</option>
                </select>
            </div>

            <!-- VDOT Form -->
            <div id="vdot-form" style="display: none;">
                <div class="form-group">
                    <label for="vdot-distance">Distance (meters):</label>
                    <input type="number" id="vdot-distance" placeholder="e.g., 5000">
                </div>
                <div class="form-group">
                    <label>Time:</label>
                    <div class="time-inputs">
                        <input type="number" id="vdot-hours" placeholder="Hours" value="0" min="0">
                        <input type="number" id="vdot-minutes" placeholder="Minutes" value="0" min="0">
                        <input type="number" id="vdot-seconds" placeholder="Seconds" value="0" min="0">
                    </div>
                </div>
            </div>

            <!-- FMR Form -->
            <div id="custom-form" style="display: none;">
                <div class="form-group">
                    <label for="custom-gender">Gender:</label>
                    <select id="custom-gender">
                        <option value="1">Male</option>
                        <option value="0">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="custom-age">Age (years):</label>
                    <input type="number" id="custom-age" placeholder="e.g., 30" min="0">
                </div>
                <div class="form-group">
                    <label>Fastest 5km Time:</label>
                    <div class="time-inputs">
                        <input type="number" id="custom-hours" placeholder="Hours" value="0" min="0">
                        <input type="number" id="custom-minutes" placeholder="Minutes" value="0" min="0">
                        <input type="number" id="custom-seconds" placeholder="Seconds" value="0" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="custom-max-hr">Max Heart Rate (bpm):</label>
                    <input type="number" id="custom-max-hr" placeholder="e.g., 190" min="0">
                </div>
                <div class="form-group">
                    <label for="custom-rest-hr">Resting Heart Rate (bpm):</label>
                    <input type="number" id="custom-rest-hr" placeholder="e.g., 60" min="0">
                </div>
            </div>

            <!-- Cooper Form -->
            <div id="cooper-form" style="display: none;">
                <div class="form-group">
                    <label for="cooper-distance">Distance Run in 12 Minutes (meters):</label>
                    <input type="number" id="cooper-distance" placeholder="e.g., 3000" min="0">
                </div>
            </div>

            <button onclick="calculateVO2Max()">Calculate VO₂ Max</button>
            <div id="vo2-result"></div>
        </div>

        <!-- Pace Calculator -->
        <div id="pace-calculator" class="calculator-content">
            <h2>Pace Calculator</h2>
            <div class="info-box">
                <p>Calculate your running pace, speed, and predicted finish times for various distances.</p>
            </div>

            <div class="form-group">
                <label for="pace-standard-distance">Standard Distance:</label>
                <select id="pace-standard-distance">
                    <option value="">--Select--</option>
                    <option value="1">1 km (0.62 miles)</option>
                    <option value="1.60934">1 mile (1.61 km)</option>
                    <option value="5">5 km (3.11 miles)</option>
                    <option value="8.04672">5 miles (8.05 km)</option>
                    <option value="10">10 km (6.21 miles)</option>
                    <option value="16.0934">10 miles (16.09 km)</option>
                    <option value="21.0975">Half Marathon (21.10 km / 13.11 miles)</option>
                    <option value="42.195">Marathon (42.20 km / 26.22 miles)</option>
                    <option value="50">50 km (31.07 miles)</option>
                    <option value="80.4672">50 miles (80.47 km)</option>
                    <option value="100">100 km (62.14 miles)</option>
                    <option value="160.934">100 miles (160.93 km)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="pace-custom-distance">Or Enter Custom Distance:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="pace-custom-distance" step="any" min="0" placeholder="Distance">
                    <select id="pace-custom-unit">
                        <option value="km">km</option>
                        <option value="mi">miles</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Time:</label>
                <div class="time-inputs">
                    <input type="number" id="pace-hours" placeholder="Hours" min="0" value="0">
                    <input type="number" id="pace-minutes" placeholder="Minutes" min="0" value="0">
                    <input type="number" id="pace-seconds" placeholder="Seconds" min="0" value="0">
                </div>
            </div>

            <button onclick="calculatePace()">Calculate Pace</button>
            <div id="pace-result"></div>
        </div>

        <!-- Race Time Predictor -->
        <div id="race-calculator" class="calculator-content">
            <h2>Race Time Predictor</h2>
            <div class="info-box">
                <p><strong>Choose Your Mode:</strong> Quick mode uses one race time with standard adjustments. Advanced mode calibrates to YOUR physiology using two races for ultra-accurate predictions.</p>
            </div>

            <div class="mode-selector">
                <div class="mode-button active" onclick="switchRaceMode('quick')">
                    ⚡ Quick Mode<br>
                    <small style="font-weight: normal; font-size: 0.85em;">One race time</small>
                </div>
                <div class="mode-button" onclick="switchRaceMode('advanced')">
                    🎯 Advanced Mode<br>
                    <small style="font-weight: normal; font-size: 0.85em;">Ultra-accurate (2 races)</small>
                </div>
            </div>

            <!-- Quick Mode -->
            <div id="race-quick-mode">
                <div class="form-group">
                    <label for="race-gender-quick">Gender:</label>
                    <select id="race-gender-quick">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="race-known-distance">Known Distance:</label>
                    <select id="race-known-distance">
                        <option value="1.60934">Mile</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="21.0975">Half Marathon</option>
                        <option value="42.195">Marathon</option>
                        <option value="50">50 km</option>
                        <option value="80.4672">50 miles</option>
                        <option value="100">100 km</option>
                        <option value="160.934">100 miles</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Time for Known Distance:</label>
                    <div class="time-inputs">
                        <input type="number" id="race-hours" placeholder="Hours" min="0" value="0">
                        <input type="number" id="race-minutes" placeholder="Minutes" min="0" value="0">
                        <input type="number" id="race-seconds" placeholder="Seconds" min="0" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label for="race-target-distance">Target Distance:</label>
                    <select id="race-target-distance">
                        <option value="1.60934">Mile</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="21.0975">Half Marathon</option>
                        <option value="42.195">Marathon</option>
                        <option value="50">50 km</option>
                        <option value="80.4672">50 miles</option>
                        <option value="100">100 km</option>
                        <option value="160.934">100 miles</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="race-experience">Experience Level:</label>
                    <select id="race-experience">
                        <option value="1.08">Beginner</option>
                        <option value="1.06">Intermediate</option>
                        <option value="1.04">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="race-endurance">Perceived Endurance (1-5):</label>
                    <input type="number" id="race-endurance" min="1" max="5" value="3" placeholder="1=Poor, 5=Excellent">
                </div>

                <button onclick="predictRaceTimeQuick()">Predict Race Time</button>
            </div>

            <!-- Advanced Mode -->
            <div id="race-advanced-mode" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="race-gender-advanced">Gender:</label>
                        <select id="race-gender-advanced">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="race-age">Age (years):</label>
                        <input type="number" id="race-age" placeholder="e.g., 35" min="15" max="99">
                    </div>
                    <div class="form-group">
                        <label for="race-weight">Weight (kg):</label>
                        <input type="number" id="race-weight" placeholder="e.g., 70" min="40" max="200" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="race-height">Height (cm):</label>
                        <input type="number" id="race-height" placeholder="e.g., 175" min="140" max="220">
                    </div>
                </div>

                <div class="race-input-group">
                    <h4>🏁 Previous Race #1 (Shorter Distance)</h4>
                    <div class="form-group">
                        <label for="race1-distance">Distance:</label>
                        <select id="race1-distance">
                            <option value="5">5 km</option>
                            <option value="10">10 km</option>
                            <option value="15">15 km</option>
                            <option value="21.0975">Half Marathon (21.1 km)</option>
                            <option value="25">25 km</option>
                            <option value="30">30 km</option>
                            <option value="42.195">Marathon (42.2 km)</option>
                            <option value="50">50 km</option>
                            <option value="80.4672">50 miles (80.5 km)</option>
                            <option value="100">100 km</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Finish Time:</label>
                        <div class="time-inputs">
                            <input type="number" id="race1-hours" placeholder="Hours" min="0" value="0">
                            <input type="number" id="race1-minutes" placeholder="Min" min="0" max="59" value="0">
                            <input type="number" id="race1-seconds" placeholder="Sec" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>

                <div class="race-input-group">
                    <h4>🏁 Previous Race #2 (Longer Distance)</h4>
                    <div class="form-group">
                        <label for="race2-distance">Distance:</label>
                        <select id="race2-distance">
                            <option value="10">10 km</option>
                            <option value="15">15 km</option>
                            <option value="21.0975">Half Marathon (21.1 km)</option>
                            <option value="25">25 km</option>
                            <option value="30">30 km</option>
                            <option value="42.195" selected>Marathon (42.2 km)</option>
                            <option value="50">50 km</option>
                            <option value="80.4672">50 miles (80.5 km)</option>
                            <option value="100">100 km</option>
                            <option value="160.934">100 miles (160.9 km)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Finish Time:</label>
                        <div class="time-inputs">
                            <input type="number" id="race2-hours" placeholder="Hours" min="0" value="0">
                            <input type="number" id="race2-minutes" placeholder="Min" min="0" max="59" value="0">
                            <input type="number" id="race2-seconds" placeholder="Sec" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>

                <button onclick="predictRaceTimeAdvanced()">🔮 Generate Personalized Predictions</button>
            </div>

            <div id="race-result"></div>
        </div>

        <!-- Age Grading Calculator -->
        <div id="agegrading-calculator" class="calculator-content">
            <h2>Age Grading Calculator</h2>
            <div class="info-box">
                <p><strong>What is Age Grading?</strong> Age grading allows runners of different ages to compare performances fairly by adjusting for the natural decline in performance with age, based on World Masters Athletics standards.</p>
            </div>

            <div class="form-group">
                <label for="ag-age">Age (30-110 years):</label>
                <input type="number" id="ag-age" placeholder="e.g., 45" min="30" max="110">
            </div>

            <div class="form-group">
                <label for="ag-gender">Gender:</label>
                <select id="ag-gender">
                    <option value="men">Male</option>
                    <option value="women">Female</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ag-event">Event:</label>
                <select id="ag-event">
                    <option value="100m">100m</option>
                    <option value="200m">200m</option>
                    <option value="400m">400m</option>
                    <option value="800m">800m</option>
                    <option value="1500m">1500m</option>
                    <option value="Mile">Mile</option>
                    <option value="3000m">3000m</option>
                    <option value="5000m">5000m</option>
                    <option value="10000m">10000m</option>
                    <option value="Half Marathon">Half Marathon</option>
                    <option value="Marathon">Marathon</option>
                </select>
            </div>

            <div class="form-group">
                <label>Performance Time:</label>
                <div class="time-inputs">
                    <input type="number" id="ag-hours" placeholder="Hours" min="0" value="0">
                    <input type="number" id="ag-minutes" placeholder="Minutes" min="0" value="0">
                    <input type="number" id="ag-seconds" placeholder="Seconds" min="0" value="0">
                </div>
            </div>

            <button onclick="calculateAgeGrading()">Calculate Age Grading</button>
            <div id="agegrading-result"></div>
        </div>

        <!-- Elevation Gain Adjustment Calculator -->
        <div id="elevation-calculator" class="calculator-content">
            <h2>Elevation Gain Adjustment Calculator</h2>
            <div class="info-box">
                <p><strong>Why Elevation Matters:</strong> Hills and mountains dramatically impact race times. This calculator uses modified Naismith's Rule to adjust your flat-course predictions for elevation changes, giving you realistic times for trail and mountain ultras.</p>
            </div>

            <div class="form-group">
                <label for="elev-distance">Race Distance (km):</label>
                <input type="number" id="elev-distance" placeholder="e.g., 50" min="1" step="0.1">
            </div>

            <div class="form-group">
                <label>Predicted Flat Course Time:</label>
                <div class="time-inputs">
                    <input type="number" id="elev-hours" placeholder="Hours" min="0" value="0">
                    <input type="number" id="elev-minutes" placeholder="Minutes" min="0" value="0">
                    <input type="number" id="elev-seconds" placeholder="Seconds" min="0" value="0">
                </div>
            </div>

            <div class="form-group">
                <label for="elev-gain">Total Elevation Gain (meters):</label>
                <input type="number" id="elev-gain" placeholder="e.g., 2000" min="0">
            </div>

            <div class="form-group">
                <label for="elev-loss">Total Elevation Loss (meters):</label>
                <input type="number" id="elev-loss" placeholder="e.g., 2000" min="0">
            </div>

            <div class="form-group">
                <label for="elev-terrain">Terrain Difficulty:</label>
                <select id="elev-terrain">
                    <option value="1.0">Smooth trail / Fire road</option>
                    <option value="1.1" selected>Moderate trail</option>
                    <option value="1.2">Technical trail / Rocky</option>
                    <option value="1.3">Very technical / Scrambling</option>
                </select>
            </div>

            <button onclick="calculateElevationAdjustment()">Calculate Adjusted Time</button>
            <div id="elevation-result"></div>
        </div>

        <!-- Training Zones Calculator -->
        <div id="zones-calculator" class="calculator-content">
            <h2>Training Zones Calculator</h2>
            <div class="info-box">
                <p><strong>Train Smarter, Not Harder:</strong> Proper training zones prevent overtraining and maximize results. 80% of your running should be in Zone 2 (easy), with 20% in higher zones for quality work.</p>
            </div>

            <div class="mode-selector" style="margin-bottom: 25px;">
                <div class="mode-button active" onclick="switchZoneMode('hr')">
                    ❤️ Heart Rate Based
                </div>
                <div class="mode-button" onclick="switchZoneMode('pace')">
                    🏃 Pace Based
                </div>
            </div>

            <!-- HR Mode -->
            <div id="zones-hr-mode">
                <div class="form-group">
                    <label for="zones-max-hr">Maximum Heart Rate (bpm):</label>
                    <input type="number" id="zones-max-hr" placeholder="e.g., 190" min="100" max="220">
                    <small style="color: #666; display: block; margin-top: 5px;">Estimate: 220 - age, or get tested for accuracy</small>
                </div>

                <div class="form-group">
                    <label for="zones-rest-hr">Resting Heart Rate (bpm):</label>
                    <input type="number" id="zones-rest-hr" placeholder="e.g., 55" min="30" max="100">
                    <small style="color: #666; display: block; margin-top: 5px;">Measure first thing in the morning</small>
                </div>
            </div>

            <!-- Pace Mode -->
            <div id="zones-pace-mode" style="display: none;">
                <div class="form-group">
                    <label for="zones-threshold-pace">Threshold Pace (min/km):</label>
                    <div class="time-inputs">
                        <input type="number" id="zones-threshold-min" placeholder="Min" min="3" max="10" value="4">
                        <input type="number" id="zones-threshold-sec" placeholder="Sec" min="0" max="59" value="30">
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">Pace you could hold for ~1 hour (like a 10K race pace for experienced runners)</small>
                </div>
            </div>

            <button onclick="calculateTrainingZones()">Calculate Training Zones</button>
            <div id="zones-result"></div>
        </div>

        <!-- Nutrition Calculator -->
        <div id="nutrition-calculator" class="calculator-content">
            <h2>Nutrition & Hydration Calculator</h2>
            <div class="info-box">
                <p><strong>Fuel Your Performance:</strong> Proper nutrition is critical for ultras. Running out of energy ("bonking") is the #1 reason people DNF. This calculator shows exactly how many calories and how much hydration you need.</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="nutr-weight">Body Weight (kg):</label>
                    <input type="number" id="nutr-weight" placeholder="e.g., 70" min="40" max="150">
                </div>
                <div class="form-group">
                    <label for="nutr-distance">Distance (km):</label>
                    <input type="number" id="nutr-distance" placeholder="e.g., 50" min="1" step="0.1">
                </div>
            </div>

            <div class="form-group">
                <label>Estimated Pace (min/km):</label>
                <div class="time-inputs">
                    <input type="number" id="nutr-pace-min" placeholder="Min" min="4" max="12" value="6">
                    <input type="number" id="nutr-pace-sec" placeholder="Sec" min="0" max="59" value="0">
                </div>
            </div>

            <div class="form-group">
                <label for="nutr-terrain">Terrain Type:</label>
                <select id="nutr-terrain">
                    <option value="1.0">Road / Flat trail</option>
                    <option value="1.1">Rolling hills</option>
                    <option value="1.2" selected>Moderate mountains</option>
                    <option value="1.3">Steep mountains</option>
                </select>
            </div>

            <div class="form-group">
                <label for="nutr-temp">Temperature (°C):</label>
                <select id="nutr-temp">
                    <option value="0.9">Cold (< 10°C)</option>
                    <option value="1.0" selected>Moderate (10-20°C)</option>
                    <option value="1.15">Warm (20-25°C)</option>
                    <option value="1.3">Hot (25-30°C)</option>
                    <option value="1.5">Very Hot (> 30°C)</option>
                </select>
            </div>

            <button onclick="calculateNutrition()">Calculate Nutrition Needs</button>
            <div id="nutrition-result"></div>
        </div>
    </div>

    <script>
        // Drawer Functions
        function openDrawer() {
            document.getElementById('calculator-drawer').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeDrawer() {
            document.getElementById('calculator-drawer').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeDrawerOnBackground(event) {
            if (event.target.id === 'calculator-drawer') {
                closeDrawer();
            }
        }

        // Close drawer on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDrawer();
            }
        });

        function selectCalculator(calcType, icon, name) {
            // Update active calculator
            document.querySelectorAll('.calculator-content').forEach(calc => {
                calc.classList.remove('active');
            });
            
            document.querySelectorAll('.calculator-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected calculator
            document.getElementById(calcType + '-calculator').classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Update header bar
            document.getElementById('active-calc-icon').textContent = icon;
            document.getElementById('active-calc-name').textContent = name;
            
            // Close drawer
            closeDrawer();
            
            // Scroll to top of calculator content smoothly
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        // Legacy function for compatibility
        function showCalculator(calcType) {
            const card = document.querySelector(`[data-calc="${calcType}"]`);
            if (card) {
                const icon = card.dataset.icon;
                const name = card.dataset.name;
                selectCalculator(calcType, icon, name);
            }
        }

        function switchRaceMode(mode) {
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            if (mode === 'quick') {
                document.getElementById('race-quick-mode').style.display = 'block';
                document.getElementById('race-advanced-mode').style.display = 'none';
            } else {
                document.getElementById('race-quick-mode').style.display = 'none';
                document.getElementById('race-advanced-mode').style.display = 'block';
            }
            
            document.getElementById('race-result').innerHTML = '';
        }

        // VO2 Max Functions
        function showVO2TestForm() {
            const testType = document.getElementById('vo2-test-type').value;
            
            document.getElementById('vdot-form').style.display = 'none';
            document.getElementById('custom-form').style.display = 'none';
            document.getElementById('cooper-form').style.display = 'none';
            document.getElementById('vo2-result').innerHTML = '';
            
            if (testType === 'vdot') {
                document.getElementById('vdot-form').style.display = 'block';
            } else if (testType === 'custom') {
                document.getElementById('custom-form').style.display = 'block';
            } else if (testType === 'cooper') {
                document.getElementById('cooper-form').style.display = 'block';
            }
        }

        function calculateVO2Max() {
            const testType = document.getElementById('vo2-test-type').value;
            let vo2max = 0;
            let resultText = '';

            if (testType === 'vdot') {
                const distance = parseFloat(document.getElementById('vdot-distance').value);
                const hours = parseFloat(document.getElementById('vdot-hours').value) || 0;
                const minutes = parseFloat(document.getElementById('vdot-minutes').value) || 0;
                const seconds = parseFloat(document.getElementById('vdot-seconds').value) || 0;

                if (isNaN(distance) || distance <= 0) {
                    alert('Please enter a valid distance in meters.');
                    return;
                }
                const totalTimeSeconds = (hours * 3600) + (minutes * 60) + seconds;
                if (totalTimeSeconds <= 0) {
                    alert('Please enter a valid time.');
                    return;
                }

                const totalTimeMinutes = totalTimeSeconds / 60;
                const speed = distance / totalTimeMinutes;
                vo2max = (0.2 * speed) + 3.5;
                
                resultText = `
                    <h3>Results</h3>
                    <div class="result-item">
                        <strong>VO₂ Max:</strong> ${vo2max.toFixed(2)} ml/kg/min
                    </div>
                    <div class="result-item">
                        <strong>Classification:</strong> ${getVO2Classification(vo2max)}
                    </div>
                `;
            } else if (testType === 'custom') {
                const gender = parseInt(document.getElementById('custom-gender').value);
                const age = parseInt(document.getElementById('custom-age').value);
                const hours = parseFloat(document.getElementById('custom-hours').value) || 0;
                const minutes = parseFloat(document.getElementById('custom-minutes').value) || 0;
                const seconds = parseFloat(document.getElementById('custom-seconds').value) || 0;
                const maxHR = parseFloat(document.getElementById('custom-max-hr').value);
                const restHR = parseFloat(document.getElementById('custom-rest-hr').value);

                if (isNaN(age) || age <= 0 || isNaN(maxHR) || maxHR <= 0 || isNaN(restHR) || restHR <= 0) {
                    alert('Please fill all required fields.');
                    return;
                }

                const totalTimeMinutes = (hours * 60) + minutes + (seconds / 60);
                if (totalTimeMinutes <= 0) {
                    alert('Please enter a valid 5km time.');
                    return;
                }

                const distance = 5000;
                const speed = distance / totalTimeMinutes;
                const vo2maxTime = (0.2 * speed) + 3.5;
                const vo2maxHR = 15 * (maxHR / restHR);
                vo2max = (vo2maxTime + vo2maxHR) / 2;

                if (gender === 0) {
                    vo2max = vo2max * 0.95;
                }

                if (age > 25) {
                    const yearsOver25 = age - 25;
                    let ageAdjustmentFactor = 1 - (0.002 * yearsOver25);
                    ageAdjustmentFactor = Math.max(ageAdjustmentFactor, 0.7);
                    vo2max = vo2max * ageAdjustmentFactor;
                }

                resultText = `
                    <h3>Results</h3>
                    <div class="result-item">
                        <strong>VO₂ Max:</strong> ${vo2max.toFixed(2)} ml/kg/min
                    </div>
                    <div class="result-item">
                        <strong>Classification:</strong> ${getVO2Classification(vo2max)}
                    </div>
                    <div class="result-item">
                        <strong>Heart Rate Reserve:</strong> ${(maxHR - restHR).toFixed(0)} bpm
                    </div>
                `;
            } else if (testType === 'cooper') {
                const distance = parseFloat(document.getElementById('cooper-distance').value);

                if (isNaN(distance) || distance <= 0) {
                    alert('Please enter a valid distance in meters.');
                    return;
                }

                vo2max = (distance - 504.9) / 44.73;
                
                resultText = `
                    <h3>Results</h3>
                    <div class="result-item">
                        <strong>VO₂ Max:</strong> ${vo2max.toFixed(2)} ml/kg/min
                    </div>
                    <div class="result-item">
                        <strong>Classification:</strong> ${getVO2Classification(vo2max)}
                    </div>
                `;
            } else {
                alert('Please select a test type.');
                return;
            }

            document.getElementById('vo2-result').innerHTML = `<div class="result">${resultText}</div>`;
        }

        function getVO2Classification(vo2) {
            if (vo2 < 35) return 'Poor';
            if (vo2 < 45) return 'Fair';
            if (vo2 < 55) return 'Good';
            if (vo2 < 65) return 'Excellent';
            return 'Superior';
        }

        // Pace Calculator Functions
        function calculatePace() {
            let distance = parseFloat(document.getElementById('pace-standard-distance').value);
            
            if (!distance || distance === 0) {
                const customDistance = parseFloat(document.getElementById('pace-custom-distance').value);
                const unit = document.getElementById('pace-custom-unit').value;
                
                if (isNaN(customDistance) || customDistance <= 0) {
                    alert('Please select or enter a valid distance.');
                    return;
                }
                
                distance = unit === 'mi' ? customDistance * 1.60934 : customDistance;
            }

            const hours = parseInt(document.getElementById('pace-hours').value) || 0;
            const minutes = parseInt(document.getElementById('pace-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('pace-seconds').value) || 0;

            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
            
            if (totalSeconds <= 0) {
                alert('Please enter a valid time.');
                return;
            }

            const pacePerKm = totalSeconds / distance;
            const pacePerMile = totalSeconds / (distance / 1.60934);
            const speedKmh = (distance / totalSeconds) * 3600;
            const speedMph = speedKmh / 1.60934;

            const paceKmMin = Math.floor(pacePerKm / 60);
            const paceKmSec = Math.floor(pacePerKm % 60);
            const paceMiMin = Math.floor(pacePerMile / 60);
            const paceMiSec = Math.floor(pacePerMile % 60);

            const distances = [
                { name: '5K', km: 5 },
                { name: '10K', km: 10 },
                { name: 'Half Marathon', km: 21.0975 },
                { name: 'Marathon', km: 42.195 }
            ];

            let predictions = '';
            distances.forEach(d => {
                const predictedSeconds = pacePerKm * d.km;
                const predHours = Math.floor(predictedSeconds / 3600);
                const predMinutes = Math.floor((predictedSeconds % 3600) / 60);
                const predSeconds = Math.floor(predictedSeconds % 60);
                
                predictions += `
                    <tr>
                        <td>${d.name}</td>
                        <td>${formatTime(predHours, predMinutes, predSeconds)}</td>
                    </tr>
                `;
            });

            const resultText = `
                <h3>Your Pace Results</h3>
                <div class="result-item">
                    <strong>Pace per km:</strong> ${paceKmMin}:${paceKmSec.toString().padStart(2, '0')} /km
                </div>
                <div class="result-item">
                    <strong>Pace per mile:</strong> ${paceMiMin}:${paceMiSec.toString().padStart(2, '0')} /mile
                </div>
                <div class="result-item">
                    <strong>Speed:</strong> ${speedKmh.toFixed(2)} km/h (${speedMph.toFixed(2)} mph)
                </div>
                <h3>Predicted Finish Times</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Distance</th>
                            <th>Predicted Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${predictions}
                    </tbody>
                </table>
            `;

            document.getElementById('pace-result').innerHTML = `<div class="result">${resultText}</div>`;
        }

        // Race Time Predictor - Quick Mode
        function predictRaceTimeQuick() {
            const gender = document.getElementById('race-gender-quick').value;
            const distance = parseFloat(document.getElementById('race-known-distance').value);
            const hours = parseInt(document.getElementById('race-hours').value) || 0;
            const minutes = parseInt(document.getElementById('race-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('race-seconds').value) || 0;
            const targetDistance = parseFloat(document.getElementById('race-target-distance').value);
            const experienceFactor = parseFloat(document.getElementById('race-experience').value);
            const endurance = parseFloat(document.getElementById('race-endurance').value);

            const totalTimeMinutes = (hours * 60) + minutes + (seconds / 60);

            if (totalTimeMinutes <= 0) {
                alert('Please enter a valid time.');
                return;
            }

            let fatigueFactor = experienceFactor;
            
            if (endurance >= 4) fatigueFactor -= 0.01;
            if (endurance === 5) fatigueFactor -= 0.02;

            // Gender adjustments for ultra distances
            if (gender === 'female' && targetDistance > 80) {
                fatigueFactor *= 0.97; // Women's advantage at 50+ miles
            }
            if (gender === 'female' && targetDistance > 150) {
                fatigueFactor *= 0.95; // Larger advantage at 100 miles
            }

            if (targetDistance > 42.195) {
                const distanceRatio = targetDistance / distance;
                if (distanceRatio > 4) {
                    fatigueFactor += 0.2;
                } else if (distanceRatio > 2) {
                    fatigueFactor += 0.1;
                }
            }

            const predictedTimeMinutes = totalTimeMinutes * Math.pow(targetDistance / distance, fatigueFactor);

            const predHours = Math.floor(predictedTimeMinutes / 60);
            const predMinutes = Math.floor(predictedTimeMinutes % 60);
            const predSeconds = Math.round((predictedTimeMinutes % 1) * 60);

            const distanceName = getDistanceName(targetDistance);

            const resultText = `
                <h3>Predicted Race Time</h3>
                <div class="result-item">
                    <strong>Distance:</strong> ${distanceName}
                </div>
                <div class="result-item">
                    <strong>Predicted Time:</strong> ${formatTime(predHours, predMinutes, predSeconds)}
                </div>
                <div class="result-item">
                    <strong>Fatigue Factor Used:</strong> ${fatigueFactor.toFixed(3)}
                </div>
                ${gender === 'female' && targetDistance > 80 ? `
                    <div class="tip-box" style="margin-top: 15px;">
                        <h4>💪 Ultra Advantage</h4>
                        <p>Research suggests women often perform relatively better at ultra distances (50+ miles). Your prediction includes this adjustment!</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('race-result').innerHTML = `<div class="result">${resultText}</div>`;
        }

        // Race Time Predictor - Advanced Mode
        function predictRaceTimeAdvanced() {
            const gender = document.getElementById('race-gender-advanced').value;
            const age = parseFloat(document.getElementById('race-age').value);
            const weight = parseFloat(document.getElementById('race-weight').value);
            const height = parseFloat(document.getElementById('race-height').value);

            const race1Distance = parseFloat(document.getElementById('race1-distance').value);
            const race1Hours = parseInt(document.getElementById('race1-hours').value) || 0;
            const race1Minutes = parseInt(document.getElementById('race1-minutes').value) || 0;
            const race1Seconds = parseInt(document.getElementById('race1-seconds').value) || 0;

            const race2Distance = parseFloat(document.getElementById('race2-distance').value);
            const race2Hours = parseInt(document.getElementById('race2-hours').value) || 0;
            const race2Minutes = parseInt(document.getElementById('race2-minutes').value) || 0;
            const race2Seconds = parseInt(document.getElementById('race2-seconds').value) || 0;

            if (isNaN(age) || isNaN(weight) || isNaN(height)) {
                alert('Please fill in your age, weight, and height.');
                return;
            }

            const race1TimeSeconds = (race1Hours * 3600) + (race1Minutes * 60) + race1Seconds;
            const race2TimeSeconds = (race2Hours * 3600) + (race2Minutes * 60) + race2Seconds;

            if (race1TimeSeconds <= 0 || race2TimeSeconds <= 0) {
                alert('Please enter valid race times for both races.');
                return;
            }

            if (race1Distance >= race2Distance) {
                alert('Race #1 should be shorter than Race #2. Please adjust your distances.');
                return;
            }

            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);

            const personalExponent = Math.log(race2TimeSeconds / race1TimeSeconds) / Math.log(race2Distance / race1Distance);

            // Age adjustment
            let ageAdjustment = 1.0;
            if (age > 35) {
                ageAdjustment = 1.0 + ((age - 35) * 0.002);
                // Women maintain fitness better after 40
                if (gender === 'female' && age > 40) {
                    ageAdjustment *= 0.98;
                }
            } else if (age < 25) {
                ageAdjustment = 1.0 + ((25 - age) * 0.001);
            }

            // Gender-adjusted optimal BMI
            const optimalBMI = gender === 'female' ? 21 : 20;
            let bmiAdjustment = 1.0;
            
            if (bmi < 18) {
                bmiAdjustment = 1.02;
            } else if (bmi > 25) {
                bmiAdjustment = 1.0 + ((bmi - 25) * 0.01);
            } else if (bmi > optimalBMI + 1) {
                bmiAdjustment = 1.0 + ((bmi - optimalBMI - 1) * 0.005);
            }

            const distances = [
                { name: '5K', km: 5, isUltra: false },
                { name: '10K', km: 10, isUltra: false },
                { name: '15K', km: 15, isUltra: false },
                { name: 'Half Marathon', km: 21.0975, isUltra: false },
                { name: '25K', km: 25, isUltra: false },
                { name: '30K', km: 30, isUltra: false },
                { name: 'Marathon', km: 42.195, isUltra: false },
                { name: '50K', km: 50, isUltra: true },
                { name: '50 Miles', km: 80.4672, isUltra: true },
                { name: '100K', km: 100, isUltra: true },
                { name: '100 Miles', km: 160.934, isUltra: true }
            ];

            // Use the shorter race as the base for backward predictions, longer race for forward predictions
            const baseDistance1 = race1Distance;
            const baseTime1 = race1TimeSeconds;
            const baseDistance2 = race2Distance;
            const baseTime2 = race2TimeSeconds;

            let resultsHTML = `
                <div class="calibration-box">
                    <h3>📊 Your Personal Running Profile</h3>
                    <div class="calibration-stat">
                        <span>Personal Fatigue Exponent:</span>
                        <strong>${personalExponent.toFixed(4)}</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Standard Riegel Exponent:</span>
                        <strong>1.0600</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>BMI:</span>
                        <strong>${bmi.toFixed(1)} kg/m²</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Efficiency Rating:</span>
                        <strong>${getEfficiencyRating(bmi, gender)}</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Age Adjustment:</span>
                        <strong>${((ageAdjustment - 1) * 100).toFixed(1)}%</strong>
                    </div>
                </div>

                <h3 style="color: #FF9900; margin-bottom: 20px;">🎯 Predicted Race Times</h3>
                <div class="predictions-grid">
            `;

            distances.forEach(distance => {
                let exponent = personalExponent;
                let baseDistance, baseTime;
                
                // Choose which known race to base the prediction on
                if (distance.km < baseDistance1) {
                    // For distances shorter than race1, use race1 as base
                    baseDistance = baseDistance1;
                    baseTime = baseTime1;
                } else if (distance.km >= baseDistance1 && distance.km <= baseDistance2) {
                    // For distances between race1 and race2, use the closer one
                    const dist1Diff = Math.abs(distance.km - baseDistance1);
                    const dist2Diff = Math.abs(distance.km - baseDistance2);
                    if (dist1Diff < dist2Diff) {
                        baseDistance = baseDistance1;
                        baseTime = baseTime1;
                    } else {
                        baseDistance = baseDistance2;
                        baseTime = baseTime2;
                    }
                } else {
                    // For distances longer than race2, use race2 as base
                    baseDistance = baseDistance2;
                    baseTime = baseTime2;
                }
                
                if (distance.isUltra) {
                    const ultraMultiplier = Math.pow(distance.km / 42.195, 0.15);
                    exponent = exponent * (1 + (ultraMultiplier * 0.08));
                    
                    if (distance.km > 80) {
                        exponent *= 1.05;
                        
                        // Women's ultra advantage
                        if (gender === 'female') {
                            exponent *= 0.97;
                        }
                    }
                    if (distance.km > 150) {
                        exponent *= 1.08;
                        
                        // Larger advantage for women at 100 miles
                        if (gender === 'female') {
                            exponent *= 0.95;
                        }
                    }
                }

                exponent *= ageAdjustment;
                exponent *= bmiAdjustment;

                let predictedSeconds = baseTime * Math.pow(distance.km / baseDistance, exponent);
                
                // CRITICAL FIX: Don't predict faster than known times for shorter distances
                if (distance.km <= race1Distance && predictedSeconds < race1TimeSeconds) {
                    predictedSeconds = race1TimeSeconds;
                }
                if (distance.km <= race2Distance && distance.km > race1Distance && predictedSeconds < race2TimeSeconds) {
                    // For intermediate distances, use interpolation instead of prediction
                    const ratio = (distance.km - race1Distance) / (race2Distance - race1Distance);
                    predictedSeconds = race1TimeSeconds + (ratio * (race2TimeSeconds - race1TimeSeconds));
                }
                
                const distanceRatio = Math.abs(Math.log(distance.km / baseDistance));
                const confidence = Math.max(50, 100 - (distanceRatio * 30));

                const pacePerKm = predictedSeconds / distance.km;
                const pacePerMile = pacePerKm * 1.60934;

                resultsHTML += generatePredictionCard(
                    distance.name,
                    distance.km,
                    predictedSeconds,
                    pacePerKm,
                    pacePerMile,
                    confidence,
                    distance.isUltra
                );
            });

            resultsHTML += `</div>`;

            if (baseDistance2 >= 42.195) {
                resultsHTML += generateUltraGuidance(personalExponent, gender);
            }

            resultsHTML += generatePacingStrategy(baseDistance2, baseTime2);

            document.getElementById('race-result').innerHTML = resultsHTML;
            document.getElementById('race-result').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function generatePredictionCard(name, km, seconds, pacePerKm, pacePerMile, confidence, isUltra) {
            const time = formatTimeFromSeconds(seconds);
            const paceKm = formatPace(pacePerKm);
            const paceMi = formatPace(pacePerMile);

            const ultraClass = isUltra ? ' ultra' : '';

            return `
                <div class="prediction-card${ultraClass}">
                    <div class="prediction-distance">${name}</div>
                    <div class="prediction-time">${time}</div>
                    <div class="prediction-details">
                        <div><strong>Pace:</strong> ${paceKm}/km</div>
                        <div><strong>Pace:</strong> ${paceMi}/mile</div>
                        <div><strong>Distance:</strong> ${km.toFixed(1)} km</div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${confidence}%"></div>
                    </div>
                    <div class="confidence-label">${confidence.toFixed(0)}% Confidence</div>
                </div>
            `;
        }

        function generateUltraGuidance(exponent, gender) {
            let guidance = '';
            
            if (exponent > 1.10) {
                guidance = `
                    <div class="warning-box">
                        <p><strong>⚠️ Ultra Distance Warning:</strong></p>
                        <p>Your fatigue factor (${exponent.toFixed(3)}) suggests you slow down significantly at longer distances. Consider:</p>
                        <p>• Building more ultra-specific training (back-to-back long runs)</p>
                        <p>• Working on mental toughness and nutrition strategies</p>
                        <p>• Starting conservatively in your next ultra</p>
                    </div>
                `;
            } else if (exponent < 1.05) {
                guidance = `
                    <div class="tip-box">
                        <h4>💪 Ultra Strength Detected!</h4>
                        <p>Your low fatigue factor (${exponent.toFixed(3)}) indicates exceptional endurance. You maintain pace well at longer distances!</p>
                    </div>
                `;
            } else {
                guidance = `
                    <div class="tip-box">
                        <h4>✅ Balanced Ultra Profile</h4>
                        <p>Your fatigue factor (${exponent.toFixed(3)}) shows good endurance balance.</p>
                    </div>
                `;
            }

            if (gender === 'female') {
                guidance += `
                    <div class="tip-box">
                        <h4>🌟 Ultra Distance Advantage</h4>
                        <p>Research shows women often perform relatively better at 50+ mile distances. Your predictions include adjustments for this physiological advantage, especially at 100 miles where the gap often narrows or reverses!</p>
                    </div>
                `;
            }

            return `
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">🏔️ Ultra Distance Insights</h3>
                    ${guidance}
                    <div class="tip-box">
                        <h4>🎯 Ultra Racing Tips</h4>
                        <ul>
                            <li><strong>50K:</strong> Slow 5-10% from marathon pace. Fuel every 30-40 minutes.</li>
                            <li><strong>50 Miles:</strong> Expect 15-25% slowdown. Practice night running.</li>
                            <li><strong>100K:</strong> Plan for 25-35% slowdown. Train stomach for 200-300 cal/hour.</li>
                            <li><strong>100 Miles:</strong> Expect 40-60% slowdown. Mental game is everything!</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function generatePacingStrategy(baseDistance, baseTimeSeconds) {
            const basePacePerKm = baseTimeSeconds / baseDistance;
            const conservativePace = basePacePerKm * 1.15;
            const targetPace = basePacePerKm * 1.08;
            const aggressivePace = basePacePerKm * 1.02;

            return `
                <div class="pacing-guide">
                    <h3>📈 Pacing Strategy Recommendations</h3>
                    <div class="pace-row">
                        <span class="pace-label">🐢 Conservative Start (First 25%):</span>
                        <span class="pace-value">${formatPace(conservativePace)}/km</span>
                    </div>
                    <div class="pace-row">
                        <span class="pace-label">🎯 Target Pace (Middle 50%):</span>
                        <span class="pace-value">${formatPace(targetPace)}/km</span>
                    </div>
                    <div class="pace-row">
                        <span class="pace-label">🚀 Push Pace (Final 25%):</span>
                        <span class="pace-value">${formatPace(aggressivePace)}/km</span>
                    </div>
                </div>
            `;
        }

        function getEfficiencyRating(bmi, gender) {
            const optimalBMI = gender === 'female' ? 21 : 20;
            if (bmi < 18) return 'Too Light ⚠️';
            if (bmi < optimalBMI - 1) return 'Very Lean 💪';
            if (bmi <= optimalBMI + 1) return 'Optimal 🌟';
            if (bmi < 25) return 'Good ✓';
            if (bmi < 27) return 'Carrying Extra 📊';
            return 'Consider Weight Loss 📊';
        }

        function getDistanceName(km) {
            const distances = {
                1.60934: '1 Mile',
                5: '5 km',
                10: '10 km',
                21.0975: 'Half Marathon',
                42.195: 'Marathon',
                50: '50 km',
                80.4672: '50 Miles',
                100: '100 km',
                160.934: '100 Miles'
            };
            return distances[km] || `${km} km`;
        }

        // Age Grading Data Storage
        let ageGradingData = null;

        // Load WMA Age Grading Data
        async function loadAgeGradingData() {
            try {
                // Try to load from local file first (for GitHub Pages hosting)
                const response = await fetch('agegradingfactors.json');
                if (!response.ok) {
                    // Fallback to remote URL
                    const fallbackResponse = await fetch('https://filmmyrun.co.uk/wp-content/assets/agegradingfactors.json');
                    ageGradingData = await fallbackResponse.json();
                } else {
                    ageGradingData = await response.json();
                }
                console.log('WMA Age Grading Data loaded successfully');
            } catch (error) {
                console.error('Error loading age grading data:', error);
                alert('Unable to load age grading data. Please ensure agegradingfactors.json is in the same directory as this HTML file.');
            }
        }

        // Load data when page loads
        loadAgeGradingData();

        // Age Grading Functions
        function calculateAgeGrading() {
            if (!ageGradingData) {
                alert('Age grading data is still loading. Please wait a moment and try again.');
                return;
            }

            const age = parseInt(document.getElementById('ag-age').value);
            const gender = document.getElementById('ag-gender').value;
            const event = document.getElementById('ag-event').value;
            const hours = parseInt(document.getElementById('ag-hours').value) || 0;
            const minutes = parseInt(document.getElementById('ag-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('ag-seconds').value) || 0;

            if (isNaN(age) || age < 30 || age > 110) {
                alert('Please enter a valid age between 30 and 110 for WMA age grading.');
                return;
            }

            const performanceSeconds = (hours * 3600) + (minutes * 60) + seconds;

            if (performanceSeconds <= 0) {
                alert('Please enter a valid time.');
                return;
            }

            const factor = getAgeGradingFactor(gender, age, event);
            const openRecord = getOpenRecord(gender, event);

            if (!factor || !openRecord) {
                alert('Age grading data not available for selected parameters.');
                return;
            }

            const ageGradedPerformanceSeconds = performanceSeconds * factor;
            const ageGradedPercentage = (openRecord / ageGradedPerformanceSeconds) * 100;

            const agHours = Math.floor(ageGradedPerformanceSeconds / 3600);
            const agMinutes = Math.floor((ageGradedPerformanceSeconds % 3600) / 60);
            const agSeconds = Math.floor(ageGradedPerformanceSeconds % 60);

            const resultText = `
                <h3>Age Grading Results</h3>
                <div class="info-box">
                    <p><strong>About This Data:</strong> These results use official World Masters Athletics (WMA) age grading factors, updated in 2023 and based on over 2.8 million performances.</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Your Performance</td>
                            <td>${formatTimeFromSeconds(performanceSeconds)}</td>
                        </tr>
                        <tr>
                            <td>Age Graded Performance</td>
                            <td>${formatTime(agHours, agMinutes, agSeconds)}</td>
                        </tr>
                        <tr>
                            <td>Age Graded %</td>
                            <td><strong>${ageGradedPercentage.toFixed(2)}%</strong></td>
                        </tr>
                        <tr>
                            <td>WMA Factor</td>
                            <td>${factor.toFixed(4)}</td>
                        </tr>
                        <tr>
                            <td>Open World Record</td>
                            <td>${formatTimeFromSeconds(openRecord)}</td>
                        </tr>
                        <tr>
                            <td>Classification</td>
                            <td><strong>${getAgeGradingClassification(ageGradedPercentage)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            `;

            document.getElementById('agegrading-result').innerHTML = `<div class="result">${resultText}</div>`;
        }

        function getAgeGradingFactor(gender, age, event) {
            if (!ageGradingData) return null;
            
            const genderKey = gender === 'men' ? 'men' : 'women';
            
            // Check if event exists in data
            if (!ageGradingData[genderKey][event]) {
                console.error(`Event ${event} not found in age grading data`);
                return null;
            }

            const eventData = ageGradingData[genderKey][event];
            const factors = eventData.age_grading_factors;
            
            // Get exact age factor or closest available
            let factor = factors[age.toString()];
            
            if (!factor) {
                // If exact age not found, find closest age
                const availableAges = Object.keys(factors).map(Number);
                const closestAge = availableAges.reduce((prev, curr) =>
                    Math.abs(curr - age) < Math.abs(prev - age) ? curr : prev
                );
                factor = factors[closestAge.toString()];
                console.warn(`Exact age ${age} not found. Using closest age ${closestAge} with factor ${factor}`);
            }

            return factor;
        }

        function getOpenRecord(gender, event) {
            if (!ageGradingData) return null;
            
            const genderKey = gender === 'men' ? 'men' : 'women';
            
            if (!ageGradingData[genderKey][event]) {
                console.error(`Event ${event} not found in age grading data`);
                return null;
            }

            return ageGradingData[genderKey][event].open_record;
        }

        function getAgeGradingClassification(percentage) {
            if (percentage >= 100) return '🏆 World Class';
            if (percentage >= 90) return '🥇 National Class';
            if (percentage >= 80) return '🥈 Regional Class';
            if (percentage >= 70) return '🥉 Local Class';
            if (percentage >= 60) return '⭐ Excellent';
            return '👍 Good';
        }

        // Elevation Gain Adjustment Functions
        function calculateElevationAdjustment() {
            const distance = parseFloat(document.getElementById('elev-distance').value);
            const hours = parseInt(document.getElementById('elev-hours').value) || 0;
            const minutes = parseInt(document.getElementById('elev-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('elev-seconds').value) || 0;
            const elevGain = parseFloat(document.getElementById('elev-gain').value) || 0;
            const elevLoss = parseFloat(document.getElementById('elev-loss').value) || 0;
            const terrainFactor = parseFloat(document.getElementById('elev-terrain').value);

            if (isNaN(distance) || distance <= 0) {
                alert('Please enter a valid distance.');
                return;
            }

            const flatTimeSeconds = (hours * 3600) + (minutes * 60) + seconds;
            if (flatTimeSeconds <= 0) {
                alert('Please enter a valid time.');
                return;
            }

            // Naismith's Rule: +1 minute per 10m elevation gain
            // Modified: -0.5 minutes per 10m elevation loss (but capped)
            const gainPenalty = (elevGain / 10) * 60; // seconds
            const lossBenefit = Math.min((elevLoss / 10) * 30, elevGain / 10 * 30); // seconds, capped at half the gain penalty

            // Apply terrain factor
            const terrainPenalty = (flatTimeSeconds * (terrainFactor - 1));

            const adjustedTimeSeconds = flatTimeSeconds + gainPenalty - lossBenefit + terrainPenalty;

            // Calculate equivalent flat distance
            const flatPacePerKm = flatTimeSeconds / distance;
            const equivalentFlatDistance = adjustedTimeSeconds / flatPacePerKm;

            const adjHours = Math.floor(adjustedTimeSeconds / 3600);
            const adjMinutes = Math.floor((adjustedTimeSeconds % 3600) / 60);
            const adjSeconds = Math.floor(adjustedTimeSeconds % 60);

            const timeDifference = adjustedTimeSeconds - flatTimeSeconds;
            const diffMinutes = Math.floor(timeDifference / 60);

            const resultText = `
                <h3>Elevation-Adjusted Results</h3>
                <div class="calibration-box">
                    <div class="calibration-stat">
                        <span>Original Flat Time:</span>
                        <strong>${formatTime(hours, minutes, seconds)}</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Adjusted Time (with elevation):</span>
                        <strong>${formatTime(adjHours, adjMinutes, adjSeconds)}</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Time Added:</span>
                        <strong>${diffMinutes} minutes</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Equivalent Flat Distance:</span>
                        <strong>${equivalentFlatDistance.toFixed(1)} km</strong>
                    </div>
                </div>

                <div class="result-item">
                    <strong>Breakdown:</strong>
                    <ul style="margin-top: 10px; line-height: 1.8;">
                        <li>Elevation gain penalty: +${Math.round(gainPenalty / 60)} min (${elevGain}m gain)</li>
                        <li>Elevation loss benefit: -${Math.round(lossBenefit / 60)} min (${elevLoss}m loss)</li>
                        <li>Terrain difficulty factor: +${Math.round(terrainPenalty / 60)} min</li>
                    </ul>
                </div>

                <div class="tip-box">
                    <h4>💡 Race Day Tips</h4>
                    <ul>
                        <li><strong>Start Conservative:</strong> Hills at the beginning feel easier than they are</li>
                        <li><strong>Walk Steep Climbs:</strong> Power hiking steep sections saves energy for later</li>
                        <li><strong>Control Descents:</strong> Eccentric muscle damage from downhills causes late-race fatigue</li>
                        <li><strong>Train Specifically:</strong> Practice your race terrain - your legs need adaptation</li>
                    </ul>
                </div>
            `;

            document.getElementById('elevation-result').innerHTML = `<div class="result">${resultText}</div>`;
        }

        // Training Zones Functions
        let currentZoneMode = 'hr';

        function switchZoneMode(mode) {
            currentZoneMode = mode;
            document.querySelectorAll('#zones-calculator .mode-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            if (mode === 'hr') {
                document.getElementById('zones-hr-mode').style.display = 'block';
                document.getElementById('zones-pace-mode').style.display = 'none';
            } else {
                document.getElementById('zones-hr-mode').style.display = 'none';
                document.getElementById('zones-pace-mode').style.display = 'block';
            }
            
            document.getElementById('zones-result').innerHTML = '';
        }

        function calculateTrainingZones() {
            let resultHTML = '';

            if (currentZoneMode === 'hr') {
                const maxHR = parseInt(document.getElementById('zones-max-hr').value);
                const restHR = parseInt(document.getElementById('zones-rest-hr').value);

                if (isNaN(maxHR) || maxHR < 100 || isNaN(restHR) || restHR < 30) {
                    alert('Please enter valid heart rate values.');
                    return;
                }

                const hrReserve = maxHR - restHR;

                // Calculate zones using Karvonen method
                const zones = [
                    { name: 'Zone 1 - Recovery', range: [0.50, 0.60], purpose: 'Active recovery, warm-up, cool-down', training: '0-10%' },
                    { name: 'Zone 2 - Aerobic Base', range: [0.60, 0.70], purpose: 'Build aerobic base, fat burning, easy runs', training: '70-80%' },
                    { name: 'Zone 3 - Tempo', range: [0.70, 0.80], purpose: 'Improve aerobic capacity, tempo runs', training: '10-15%' },
                    { name: 'Zone 4 - Threshold', range: [0.80, 0.90], purpose: 'Lactate threshold, race pace for 10K-Half', training: '5-10%' },
                    { name: 'Zone 5 - VO₂ Max', range: [0.90, 1.00], purpose: 'Improve VO₂ max, intervals, 5K race pace', training: '0-5%' }
                ];

                resultHTML = `
                    <h3>Your Training Zones (Heart Rate)</h3>
                    <div class="info-box">
                        <p><strong>Heart Rate Reserve:</strong> ${hrReserve} bpm (Max ${maxHR} - Rest ${restHR})</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>HR Range (bpm)</th>
                                <th>% of Max HR</th>
                                <th>Purpose</th>
                                <th>Training %</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                zones.forEach(zone => {
                    const minHR = Math.round(restHR + (hrReserve * zone.range[0]));
                    const maxHRZone = Math.round(restHR + (hrReserve * zone.range[1]));
                    const minPercent = Math.round(zone.range[0] * 100);
                    const maxPercent = Math.round(zone.range[1] * 100);

                    resultHTML += `
                        <tr>
                            <td><strong>${zone.name}</strong></td>
                            <td>${minHR} - ${maxHRZone}</td>
                            <td>${minPercent}% - ${maxPercent}%</td>
                            <td>${zone.purpose}</td>
                            <td>${zone.training}</td>
                        </tr>
                    `;
                });

                resultHTML += `
                        </tbody>
                    </table>
                `;

            } else {
                // Pace-based zones
                const thresholdMin = parseInt(document.getElementById('zones-threshold-min').value);
                const thresholdSec = parseInt(document.getElementById('zones-threshold-sec').value) || 0;

                if (isNaN(thresholdMin) || thresholdMin < 3) {
                    alert('Please enter a valid threshold pace.');
                    return;
                }

                const thresholdPaceSeconds = (thresholdMin * 60) + thresholdSec;

                const zones = [
                    { name: 'Zone 1 - Recovery', factor: 1.25, purpose: 'Active recovery runs' },
                    { name: 'Zone 2 - Easy/Base', factor: 1.15, purpose: 'Build aerobic base (most training here!)' },
                    { name: 'Zone 3 - Tempo', factor: 1.05, purpose: 'Aerobic capacity, tempo runs' },
                    { name: 'Zone 4 - Threshold', factor: 1.0, purpose: 'Lactate threshold, 10K-Half race pace' },
                    { name: 'Zone 5 - VO₂ Max', factor: 0.90, purpose: '5K race pace, intervals' }
                ];

                resultHTML = `
                    <h3>Your Training Zones (Pace)</h3>
                    <div class="info-box">
                        <p><strong>Threshold Pace:</strong> ${thresholdMin}:${thresholdSec.toString().padStart(2, '0')}/km (baseline for zone calculation)</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Pace Range (min/km)</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                zones.forEach(zone => {
                    const zonePaceSeconds = thresholdPaceSeconds * zone.factor;
                    const paceMin = Math.floor(zonePaceSeconds / 60);
                    const paceSec = Math.round(zonePaceSeconds % 60);

                    resultHTML += `
                        <tr>
                            <td><strong>${zone.name}</strong></td>
                            <td>~${paceMin}:${paceSec.toString().padStart(2, '0')}/km</td>
                            <td>${zone.purpose}</td>
                        </tr>
                    `;
                });

                resultHTML += `
                        </tbody>
                    </table>
                `;
            }

            resultHTML += `
                <div class="tip-box">
                    <h4>🎯 The 80/20 Rule</h4>
                    <p><strong>80% of your training should be EASY (Zone 2)</strong> - this builds your aerobic base without excessive fatigue. The remaining 20% should be quality work (Zones 3-5).</p>
                    <ul>
                        <li><strong>Weekly Structure:</strong> 4 easy runs + 1 tempo + 1 interval session works well</li>
                        <li><strong>Ultra Training:</strong> Focus even more on Zone 2 - aim for 85-90% easy running</li>
                        <li><strong>Signs You're Going Too Hard:</strong> Tired legs on easy runs, elevated resting HR, poor sleep</li>
                    </ul>
                </div>
            `;

            document.getElementById('zones-result').innerHTML = `<div class="result">${resultHTML}</div>`;
        }

        // Nutrition Calculator Functions
        function calculateNutrition() {
            const weight = parseFloat(document.getElementById('nutr-weight').value);
            const distance = parseFloat(document.getElementById('nutr-distance').value);
            const paceMin = parseInt(document.getElementById('nutr-pace-min').value);
            const paceSec = parseInt(document.getElementById('nutr-pace-sec').value) || 0;
            const terrainFactor = parseFloat(document.getElementById('nutr-terrain').value);
            const tempFactor = parseFloat(document.getElementById('nutr-temp').value);

            if (isNaN(weight) || isNaN(distance) || isNaN(paceMin)) {
                alert('Please fill in all required fields.');
                return;
            }

            const paceMinPerKm = paceMin + (paceSec / 60);
            const totalTimeHours = (distance * paceMinPerKm) / 60;
            const speedKmh = 60 / paceMinPerKm;

            // Calorie calculation: approximately 1 kcal per kg per km, adjusted for speed and terrain
            const baseCaloriesPerHour = weight * speedKmh;
            const adjustedCaloriesPerHour = baseCaloriesPerHour * terrainFactor * tempFactor;
            const totalCalories = adjustedCaloriesPerHour * totalTimeHours;

            // Carb needs (60-90g per hour for events > 2.5 hours)
            const carbsPerHour = totalTimeHours > 2.5 ? 70 : 50;
            const totalCarbs = carbsPerHour * totalTimeHours;

            // Hydration (500-800ml per hour, adjusted for temperature)
            const baseHydrationPerHour = 600;
            const hydrationPerHour = Math.round(baseHydrationPerHour * tempFactor);
            const totalHydration = hydrationPerHour * totalTimeHours;

            // Sodium (300-700mg per hour for long events)
            const sodiumPerHour = 500;
            const totalSodium = sodiumPerHour * totalTimeHours;

            const resultHTML = `
                <h3>Your Nutrition & Hydration Plan</h3>
                
                <div class="calibration-box">
                    <h3>Race Overview</h3>
                    <div class="calibration-stat">
                        <span>Estimated Race Time:</span>
                        <strong>${totalTimeHours.toFixed(1)} hours</strong>
                    </div>
                    <div class="calibration-stat">
                        <span>Average Speed:</span>
                        <strong>${speedKmh.toFixed(1)} km/h</strong>
                    </div>
                </div>

                <h3 style="margin-top: 25px;">Hourly Requirements</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Per Hour</th>
                            <th>Total Race</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Calories</strong></td>
                            <td>${Math.round(adjustedCaloriesPerHour)} kcal/hr</td>
                            <td>${Math.round(totalCalories)} kcal</td>
                        </tr>
                        <tr>
                            <td><strong>Carbohydrates</strong></td>
                            <td>${carbsPerHour}g/hr</td>
                            <td>${Math.round(totalCarbs)}g</td>
                        </tr>
                        <tr>
                            <td><strong>Hydration</strong></td>
                            <td>${hydrationPerHour}ml/hr</td>
                            <td>${(totalHydration / 1000).toFixed(1)}L</td>
                        </tr>
                        <tr>
                            <td><strong>Sodium</strong></td>
                            <td>${sodiumPerHour}mg/hr</td>
                            <td>${Math.round(totalSodium)}mg</td>
                        </tr>
                    </tbody>
                </table>

                <div class="tip-box">
                    <h4>🍌 Practical Aid Station Strategy</h4>
                    <p><strong>Every hour, aim to consume:</strong></p>
                    <ul>
                        <li>${Math.round(carbsPerHour / 25)} energy gels (25g carbs each) OR</li>
                        <li>Mix of: 1-2 gels + sports drink + real food (banana, PB&J, pretzels)</li>
                        <li>${Math.round(hydrationPerHour / 500)} bottles of water/sports drink (500ml each)</li>
                        <li>Electrolyte tablets or salt capsules for sodium</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Pro Tips:</strong></p>
                    <ul>
                        <li><strong>Start early:</strong> Begin fueling at 30-45 minutes, not when you feel hungry</li>
                        <li><strong>Practice:</strong> Train your gut in training - never try new foods on race day</li>
                        <li><strong>Real food:</strong> After 4+ hours, real food often sits better than gels</li>
                        <li><strong>Caffeinated gels:</strong> Save for the last 1/3 of the race for mental boost</li>
                        <li><strong>Drink to thirst:</strong> Don't overhydrate - listen to your body</li>
                    </ul>
                </div>

                ${totalTimeHours > 6 ? `
                    <div class="warning-box">
                        <p><strong>⚠️ Ultra Distance Alert (${totalTimeHours.toFixed(1)} hours)</strong></p>
                        <p>For races over 6 hours, your gut may struggle. Consider:</p>
                        <p>• Mix liquid and solid calories (don't rely on gels alone)</p>
                        <p>• Use real food: boiled potatoes with salt, rice balls, soup</p>
                        <p>• Take walk breaks at aid stations to aid digestion</p>
                        <p>• Have a crew prepare foods you're craving</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('nutrition-result').innerHTML = `<div class="result">${resultHTML}</div>`;
        }

        // Utility Functions
        function formatTime(hours, minutes, seconds) {
            let result = '';
            if (hours > 0) {
                result += `${hours}h `;
            }
            result += `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
            return result;
        }

        function formatTimeFromSeconds(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return formatTime(hours, minutes, seconds);
        }

        function formatPace(secondsPerKm) {
            const minutes = Math.floor(secondsPerKm / 60);
            const seconds = Math.floor(secondsPerKm % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>